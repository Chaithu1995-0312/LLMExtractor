from flask import Flask, request, jsonify
import os
import sys
from datetime import datetime, timezone

# Adjust the path to import CortexAPI from the same directory
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
from api import CortexAPI

# Adjust path to import recall_bricks_readonly from nexus-cli
# This assumes nexus-cli is a sibling directory to backend/cortex
# In a deployed environment, nexus.ask.recall would be properly installed and discoverable
current_dir = os.path.dirname(os.path.abspath(__file__))
nexus_cli_path = os.path.abspath(os.path.join(current_dir, "..", "..", "nexus-cli"))
sys.path.append(nexus_cli_path)

from nexus.ask.recall import recall_bricks_readonly

app = Flask(__name__)
cortex_api = CortexAPI()

def get_utc_now():
    return datetime.now(timezone.utc).isoformat()

@app.route("/jarvis/ask-preview", methods=["GET"])
def jarvis_ask_preview():
    query = request.args.get("query")
    if not query:
        return jsonify({"error": "Query parameter is required"}), 400

    # Use the read-only recall adapter
    recalled_bricks = recall_bricks_readonly(query)

    top_bricks_output = [
        {"brick_id": brick["brick_id"], "confidence": round(brick["confidence"], 4)}
        for brick in recalled_bricks
    ]

    response_data = {
        "query": query,
        "top_bricks": top_bricks_output,
        "status": "preview"
    }
    return jsonify(response_data)

if __name__ == "__main__":
    # For development purposes, run with debug true
    # In production, use a production-ready WSGI server like Gunicorn
    app.run(debug=True, port=5001)
